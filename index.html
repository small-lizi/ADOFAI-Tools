<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ADOFAI Tools</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #36393f;
            color: #dcddde;
            height: 100vh;
            display: flex;
            overflow: hidden;
            padding-top: 40px; /* 匹配新的标题栏高度 */
        }

        /* 栏目列表侧边栏 */
        .servers-sidebar {
            width: 72px;
            background-color: #202225;
            padding: 12px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 100;
            justify-content: space-between; /* 添加这行 */
        }

        .sidebar-top {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .sidebar-bottom {
            padding-bottom: 12px;
        }

        .server-icon {
            width: 48px;
            height: 48px;
            background-color: #36393f;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .server-icon.active {
            background-color: #5865f2;
            border-radius: 16px;
        }

        .server-icon img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .server-icon:hover {
            border-radius: 16px;
            background-color: #5865f2;
        }

        .server-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%) scale(0);
            background-color: #18191c;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .server-icon:hover::after {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }

        .server-icon::before {
            content: '';
            position: absolute;
            left: 54px;
            top: 50%;
            transform: translateY(-50%) scale(0);
            border: 6px solid transparent;
            border-right-color: #18191c;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left;
        }

        .server-icon:hover::before {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }

        /* 内容区域容器 */
        .content-container {
            flex: 1;
            display: none;
            position: absolute;
            left: 72px;
            right: 0;
            top: 40px; /* 匹配新的标题栏高度 */
            bottom: 0;
            background-color: #36393f;
        }

        .content-container.active {
            display: flex;
        }

        /* 首页内容 */
        .home-content {
            flex: 1;
            display: none;
        }

        .home-content.active {
            display: flex;
        }

        .webview-container {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* 频道列表 */
        .channels-sidebar {
            width: 240px;
            background-color: #2f3136;
            display: flex;
            flex-direction: column;
        }

        .server-header {
            padding: 12px 16px;
            height: 48px;
            border-bottom: 1px solid #202225;
            font-weight: bold;
        }

        .channel-list {
            padding: 8px;
        }

        .channel-item {
            padding: 6px 8px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: #8e9297;
        }

        .channel-item:hover {
            background-color: #36393f;
            color: #dcddde;
        }

        .channel-item::before {
            content: "#";
            margin-right: 6px;
        }

        /* 主聊天区域 */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #36393f;
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #2f3136;
            border-bottom: 1px solid #202225;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .selected-tool-name {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .header-right {
            display: flex;
            gap: 8px;
        }

        .header-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: transparent;
            color: #b9bbbe;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-button:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .header-button.active {
            background: #5865f2;
            color: #fff;
        }

        .tool-info, .tool-docs {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #36393f;
            color: #dcddde;
        }

        .tool-info.active, .tool-docs.active {
            display: block;
        }

        .tool-info-header {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            background: #2f3136;
            padding: 16px;
            border-radius: 8px;
        }

        .tool-info-icon {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            overflow: hidden;
            background: #202225;
        }

        .tool-info-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tool-info-main {
            flex: 1;
        }

        .tool-info-title {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .tool-info-meta {
            display: flex;
            gap: 16px;
            color: #b9bbbe;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .tool-info-author {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: #00b0f4;
        }

        .author-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            overflow: hidden;
            background: #202225;
        }

        .author-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tool-info-description {
            color: #dcddde;
            line-height: 1.6;
            margin-bottom: 24px;
            background: #2f3136;
            padding: 16px;
            border-radius: 8px;
        }

        .tool-info-section {
            margin-top: 24px;
            padding: 16px;
            background: #2f3136;
            border-radius: 8px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 16px;
        }

        .changelog {
            color: #b9bbbe;
            line-height: 1.6;
            white-space: pre-line;
        }

        .docs-webview {
            width: 100%;
            height: 100%;
            border: none;
            background: #ffffff;
        }

        .error-message {
            text-align: center;
            color: #dcddde;
            padding: 20px;
        }

        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #202225;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2f3136;
        }

        /* 可滚动区域添加内边距，防止滚动条遮挡内容 */
        .tool-list, .chat-messages {
            padding-right: 12px;
            overflow-x: hidden; /* 防止水平滚动 */
        }

        /* 工具列表样式优化 */
        .tool-list {
            padding: 8px;
            overflow-y: auto;
            flex: 1;
        }

        .tool-item {
            padding: 10px;
            margin: 2px 0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #8e9297;
            position: relative;
        }

        .tool-item:hover {
            background-color: #36393f;
            color: #dcddde;
        }

        .tool-item.active {
            background-color: #393c43;
            color: #fff;
        }

        .tool-icon {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            background-color: #202225;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-icon img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .tool-name {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        /* 工具名称悬停提示 */
        .tool-item::after {
            content: attr(data-tooltip);
            position: absolute;
            left: calc(100% + 8px);
            top: 50%;
            transform: translateY(-50%) scale(0);
            background-color: #18191c;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .tool-item::before {
            content: '';
            position: absolute;
            left: calc(100% + 2px);
            top: 50%;
            transform: translateY(-50%) scale(0);
            border: 6px solid transparent;
            border-right-color: #18191c;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left;
            z-index: 1000;
        }

        .tool-item:hover::after {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }

        .tool-item:hover::before {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }

        /* 下载按钮样式 */
        .download-button {
            display: inline-block;
            padding: 12px 24px;
            background: #5865f2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .download-button:hover {
            background: #4752c4;
        }

        .download-button:disabled {
            background: #72767d;
            cursor: not-allowed;
        }

        .download-progress {
            margin-top: 8px;
            width: 100%;
            height: 4px;
            background: #2f3136;
            border-radius: 2px;
            overflow: hidden;
        }

        .download-progress-bar {
            height: 100%;
            background: #5865f2;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* 标题栏样式 */
        .titlebar {
            height: 40px; /* 增加高度 */
            background: #202225;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            -webkit-app-region: drag;
        }

        .titlebar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .titlebar-icon {
            width: 24px;
            height: 24px;
        }

        .titlebar-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .titlebar-title {
            color: #dcddde;
            font-size: 14px;
        }

        .titlebar-controls {
            display: flex;
            -webkit-app-region: no-drag;
        }

        .titlebar-button {
            width: 46px; /* 增加按钮宽度 */
            height: 40px; /* 增加按钮高度 */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #dcddde;
            transition: background 0.2s;
            cursor: pointer;
        }

        .titlebar-button svg {
            width: 16px; /* 增加图标大小 */
            height: 16px;
        }

        .titlebar-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .titlebar-button.close:hover {
            background: #e81123;
        }
    </style>
</head>
<body>
    <!-- 添加标题栏 -->
    <div class="titlebar">
        <div class="titlebar-left">
            <div class="titlebar-icon">
                <img src="assets/img/icon.png" alt="ADOFAI Tools">
            </div>
            <div class="titlebar-title">ADOFAI Tools</div>
        </div>
        <div class="titlebar-controls">
            <div class="titlebar-button" id="minimize-button">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <path fill="currentColor" d="M2 6h8v1H2z"/>
                </svg>
            </div>
            <div class="titlebar-button" id="maximize-button">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <path fill="currentColor" d="M2 2v8h8V2H2zm7 7H3V3h6v6z"/>
                </svg>
            </div>
            <div class="titlebar-button close" id="close-button">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <path fill="currentColor" d="M7.414 6l2.293-2.293a1 1 0 00-1.414-1.414L6 4.586 3.707 2.293a1 1 0 00-1.414 1.414L4.586 6 2.293 8.293a1 1 0 101.414 1.414L6 7.414l2.293 2.293a1 1 0 001.414-1.414L7.414 6z"/>
                </svg>
            </div>
        </div>
    </div>

    <!-- 修改servers-sidebar结构 -->
    <div class="servers-sidebar">
        <div class="sidebar-top">
            <div class="server-icon active" data-page="home" data-tooltip="首页">
                <img src="assets/img/shouye.png" alt="首页">
            </div>
            <div class="server-icon" data-page="tools" data-tooltip="工具">
                <img src="assets/img/tools.png" alt="工具">
            </div>
            <div class="server-icon" data-page="charts" data-tooltip="谱面下载">
                <img src="assets/img/chart.png" alt="谱面下载">
            </div>
        </div>
        <div class="sidebar-bottom">
            <div class="server-icon" id="admin-console" data-tooltip="开发者控制台">
                <img src="assets/img/admin.png" alt="开发者控制台">
            </div>
        </div>
    </div>

    <!-- 首页内容 -->
    <div class="content-container home-content active" id="home">
        <iframe class="webview-container" src="https://adofaitools.top/announcement/viewer.html" frameborder="0"></iframe>
    </div>

    <!-- 工具页面内容 -->
    <div class="content-container" id="tools">
        <!-- 工具列表侧边栏 -->
        <div class="channels-sidebar">
            <div class="server-header">
                可用工具
            </div>
            <div class="tool-list" id="tool-list">
                <!-- 工具列表将通过 JavaScript 动态生成 -->
            </div>
        </div>

        <!-- 聊天区域 -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="header-left">
                    <div class="selected-tool-name">选择一个工具开始使用</div>
                </div>
                <div class="header-right">
                    <button class="header-button active" data-page="info">信息</button>
                    <button class="header-button" data-page="docs">文档</button>
                </div>
            </div>
            <div class="tool-info active">
                <!-- 工具信息将通过JavaScript动态生成 -->
            </div>
            <div class="tool-docs">
                <webview class="docs-webview" 
                    allowpopups 
                    webpreferences="contextIsolation=false"
                    partition="persist:main"
                    plugins
                    useragent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"></webview>
                </webview>
            </div>
        </div>
    </div>

    <!-- 谱面下载页面内容 -->
    <div class="content-container" id="charts">
        <!-- 谱面列表侧边栏 -->
        <div class="channels-sidebar">
            <div class="server-header">
                谱面列表
            </div>
            <div class="tool-list" id="charts-list">
                <!-- 谱面列表将通过 JavaScript 动态生成 -->
            </div>
        </div>

        <!-- 谱面预览区域 -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="header-left">
                    <div class="selected-tool-name">选择一个谱面查看详情</div>
                </div>
            </div>
            <webview class="docs-webview" 
                allowpopups 
                webpreferences="contextIsolation=false"
                partition="persist:main"
                plugins
                useragent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36">
            </webview>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        // 页面切换功能
        const icons = document.querySelectorAll('.server-icon');
        const pages = document.querySelectorAll('.content-container');

        icons.forEach(icon => {
            icon.addEventListener('click', () => {
                // 移除所有活动状态
                icons.forEach(i => i.classList.remove('active'));
                pages.forEach(p => p.classList.remove('active'));

                // 添加当前选中项的活动状态
                icon.classList.add('active');
                const pageId = icon.getAttribute('data-page');
                document.getElementById(pageId).classList.add('active');

                // 如果切换到谱面页面，加载谱面列表
                if (pageId === 'charts') {
                    loadCharts();
                }
                // 如果切换到工具页面，重新加载工具列表
                else if (pageId === 'tools') {
                    loadTools();
                }
            });
        });

        // 工具信息和文档页面切换
        const headerButtons = document.querySelectorAll('.header-button');
        const toolInfo = document.querySelector('.tool-info');
        const toolDocs = document.querySelector('.tool-docs');
        const docsWebview = document.querySelector('.docs-webview');

        // webview事件监听
        docsWebview.addEventListener('did-start-loading', () => {
            console.log('文档开始加载');
            toolDocs.querySelector('.error-message')?.remove();
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'error-message';
            loadingMsg.textContent = '正在加载文档...';
            toolDocs.appendChild(loadingMsg);
        });

        docsWebview.addEventListener('did-stop-loading', () => {
            console.log('文档加载停止');
            toolDocs.querySelector('.error-message')?.remove();
        });

        docsWebview.addEventListener('did-fail-load', (e) => {
            console.error('文档加载失败:', e);
            toolDocs.querySelector('.error-message')?.remove();
            const errorMsg = document.createElement('div');
            errorMsg.textContent = e.errorCode === -3 ? 
                '文档地址无效或无法访问' : 
                '文档加载失败，请稍后重试';
            toolDocs.appendChild(errorMsg);
        });

        // 处理新窗口打开请求
        docsWebview.addEventListener('new-window', (e) => {
            const protocol = require('url').parse(e.url).protocol;
            if (protocol === 'http:' || protocol === 'https:') {
                docsWebview.src = e.url;
            }
        });

        // 工具点击事件处理
        function handleToolClick(tool) {
            // 移除其他工具的选中状态
            document.querySelectorAll('.tool-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 添加当前工具的选中状态
            const toolItem = document.querySelector(`[data-tool-id="${tool.id}"]`);
            if (toolItem) {
                toolItem.classList.add('active');
            }
            
            // 更新工具信息
            updateToolInfo(tool);
            
            // 如果当前是文档页面，加载文档
            if (headerButtons[1].classList.contains('active') && tool.documentation) {
                docsWebview.src = tool.documentation;
            }
        }

        // 页面切换按钮事件处理
        headerButtons.forEach(button => {
            button.addEventListener('click', async () => {
                headerButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                const page = button.getAttribute('data-page');
                if (page === 'info') {
                    toolInfo.classList.add('active');
                    toolDocs.classList.remove('active');
                } else {
                    toolInfo.classList.remove('active');
                    toolDocs.classList.add('active');
                    
                    const selectedTool = document.querySelector('.tool-item.active');
                    if (selectedTool) {
                        const tools = await ipcRenderer.invoke('get-tools-json');
                        const tool = tools.find(t => t.id === selectedTool.getAttribute('data-tool-id'));
                        if (tool?.documentation) {
                            docsWebview.src = tool.documentation;
                        }
                    }
                }
            });
        });

        // 工具列表点击事件处理
        function addToolClickListener(toolItem, tool) {
            toolItem.addEventListener('click', () => handleToolClick(tool));
        }

        async function loadTools() {
            try {
                console.log('开始加载工具列表');
                const tools = await ipcRenderer.invoke('get-tools-json');
                console.log('获取到工具列表:', tools);
                
                if (!tools) {
                    throw new Error('无法获取工具列表数据');
                }

                const toolsArray = Array.isArray(tools) ? tools : [];
                const toolList = document.getElementById('tool-list');
                toolList.innerHTML = '';

                if (toolsArray.length === 0) {
                    toolList.innerHTML = '<div class="error-message">暂无可用工具</div>';
                    return;
                }

                let firstTool = null;

                toolsArray.forEach(tool => {
                    if (!tool || !tool.name) return;

                    const toolItem = document.createElement('div');
                    toolItem.className = 'tool-item';
                    toolItem.setAttribute('data-tooltip', tool.name);
                    toolItem.setAttribute('data-tool-id', tool.id);
                    
                    const iconContainer = document.createElement('div');
                    iconContainer.className = 'tool-icon';

                    const icon = document.createElement('img');
                    icon.src = tool.icon || 'assets/img/default-tool-icon.png';
                    icon.alt = tool.name;
                    icon.onerror = () => {
                        icon.src = 'assets/img/default-tool-icon.png';
                    };

                    const name = document.createElement('div');
                    name.className = 'tool-name';
                    name.textContent = tool.name;

                    iconContainer.appendChild(icon);
                    toolItem.appendChild(iconContainer);
                    toolItem.appendChild(name);

                    // 使用新的点击事件处理函数
                    addToolClickListener(toolItem, tool);
                    toolList.appendChild(toolItem);

                    // 记录第一个工具
                    if (!firstTool) {
                        firstTool = { tool, item: toolItem };
                    }
                });

                // 自动选中第一个工具
                if (firstTool) {
                    handleToolClick(firstTool.tool);
                }
            } catch (error) {
                console.error('加载工具列表失败:', error);
                const toolList = document.getElementById('tool-list');
                toolList.innerHTML = '<div class="error-message">加载工具列表失败，请稍后重试</div>';
            }
        }

        async function updateToolInfo(tool) {
            const toolInfo = document.querySelector('.tool-info');
            const installInfo = await ipcRenderer.invoke('check-tool-installed', tool.id);
            
            toolInfo.innerHTML = `
                <div class="tool-info-header">
                    <div class="tool-info-icon">
                        <img src="${tool.icon || 'assets/img/default-tool-icon.png'}" alt="${tool.name}" 
                            onerror="this.src='assets/img/default-tool-icon.png'">
                    </div>
                    <div class="tool-info-main">
                        <div class="tool-info-title">${tool.name}</div>
                        <div class="tool-info-meta">
                            <span>版本 ${tool.version}</span>
                            <span>发布于 ${tool.releaseDate}</span>
                            <span>下载量 ${tool.downloads}</span>
                        </div>
                        <a href="${tool.author.link}" class="tool-info-author" target="_blank">
                            <div class="author-avatar">
                                <img src="${tool.author.avatar}" alt="${tool.author.name}"
                                    onerror="this.src='assets/img/default-avatar.png'">
                            </div>
                            <span>${tool.author.name}</span>
                        </a>
                        <div class="tool-actions" style="margin-top: 12px;">
                            <button class="download-button" data-tool-id="${tool.id}" ${installInfo ? 'data-installed="true"' : ''}>
                                ${installInfo ? (installInfo.version === tool.version ? '打开' : '更新') : '下载'}
                            </button>
                            <div class="download-progress" style="display: none;">
                                <div class="download-progress-bar"></div>
                                <div class="download-status" style="margin-top: 4px; font-size: 12px; color: #b9bbbe;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tool-info-description">${tool.description}</div>
                ${tool.changelog ? `
                <div class="tool-info-section">
                    <div class="section-title">更新日志</div>
                    <div class="changelog">${tool.changelog}</div>
                </div>
                ` : ''}
            `;

            // 获取已有的下载状态
            const downloadState = window.downloadStates?.[tool.id];
            const downloadButton = toolInfo.querySelector('.download-button');
            const progressContainer = toolInfo.querySelector('.download-progress');
            const progressBar = toolInfo.querySelector('.download-progress-bar');
            const progressStatus = toolInfo.querySelector('.download-status');

            // 如果存在下载状态，恢复UI
            if (downloadState) {
                if (downloadState.completed) {
                    downloadButton.textContent = '打开';
                    downloadButton.dataset.installed = 'true';
                } else if (downloadState.error) {
                    downloadButton.textContent = '重试';
                    downloadButton.disabled = false;
                } else {
                    downloadButton.disabled = true;
                    progressContainer.style.display = 'block';
                    progressBar.style.width = `${downloadState.progress}%`;
                    progressStatus.textContent = `${(downloadState.current / 1024 / 1024).toFixed(2)}MB / ${(downloadState.total / 1024 / 1024).toFixed(2)}MB`;
                }
            }

            // 添加下载按钮事件监听
            downloadButton.addEventListener('click', async () => {
                // 如果是已安装状态
                if (downloadButton.dataset.installed === 'true') {
                    // 检查是否需要更新
                    const installInfo = await ipcRenderer.invoke('check-tool-installed', tool.id);
                    if (installInfo && installInfo.version !== tool.version) {
                        // 需要更新，执行更新流程
                        downloadButton.disabled = true;
                        progressContainer.style.display = 'block';

                        try {
                            // 初始化或更新下载状态
                            if (!window.downloadStates) window.downloadStates = {};
                            window.downloadStates[tool.id] = {
                                progress: 0,
                                current: 0,
                                total: 0
                            };

                            // 发送下载开始请求到服务器
                            try {
                                const response = await fetch('https://adofaitools.top/api/update_downloads.php', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        toolId: tool.id
                                    })
                                });

                                if (!response.ok) {
                                    throw new Error('Failed to update download count');
                                }

                                // 从服务器重新获取工具列表以更新下载量
                                const updatedTools = await ipcRenderer.invoke('get-tools-json');
                                const updatedTool = updatedTools.find(t => t.id === tool.id);
                                if (updatedTool) {
                                    // 更新下载量显示
                                    const downloadsSpan = toolInfo.querySelector('.tool-info-meta span:nth-child(3)');
                                    if (downloadsSpan) {
                                        downloadsSpan.textContent = `下载量 ${updatedTool.downloads}`;
                                    }
                                }
                            } catch (error) {
                                console.error('更新下载量失败:', error);
                            }

                            // 删除旧版本
                            await ipcRenderer.invoke('delete-tool', tool.id);
                            // 下载新版本
                            await ipcRenderer.invoke('download-tool', tool);
                            
                            window.downloadStates[tool.id].completed = true;
                            downloadButton.textContent = '打开';
                            downloadButton.dataset.installed = 'true';
                            progressContainer.style.display = 'none';
                        } catch (error) {
                            console.error('更新失败:', error);
                            window.downloadStates[tool.id].error = true;
                            downloadButton.textContent = '更新失败';
                            const errorMsg = error.message.includes('INVALID_FORMAT') ? 
                                '文件格式错误，请联系工具作者' : 
                                '更新失败，请检查网络后重试';
                            
                            progressStatus.textContent = errorMsg;
                            
                            setTimeout(() => {
                                downloadButton.textContent = '重试更新';
                                downloadButton.disabled = false;
                                progressStatus.textContent = '';
                            }, 3000);
                        }
                    } else {
                        // 不需要更新，直接打开
                        ipcRenderer.invoke('open-tool-dir', tool.id);
                    }
                    return;
                }

                // 以下是新安装的逻辑
                downloadButton.disabled = true;
                progressContainer.style.display = 'block';

                try {
                    // 初始化或更新下载状态
                    if (!window.downloadStates) window.downloadStates = {};
                    window.downloadStates[tool.id] = {
                        progress: 0,
                        current: 0,
                        total: 0
                    };

                    // 发送下载开始请求到服务器
                    try {
                        const response = await fetch('https://adofaitools.top/api/update_downloads.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                toolId: tool.id
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to update download count');
                        }

                        // 从服务器重新获取工具列表以更新下载量
                        const updatedTools = await ipcRenderer.invoke('get-tools-json');
                        const updatedTool = updatedTools.find(t => t.id === tool.id);
                        if (updatedTool) {
                            // 更新下载量显示
                            const downloadsSpan = toolInfo.querySelector('.tool-info-meta span:nth-child(3)');
                            if (downloadsSpan) {
                                downloadsSpan.textContent = `下载量 ${updatedTool.downloads}`;
                            }
                        }
                    } catch (error) {
                        console.error('更新下载量失败:', error);
                    }

                    await ipcRenderer.invoke('download-tool', tool);
                    
                    window.downloadStates[tool.id].completed = true;
                    downloadButton.textContent = '打开';
                    downloadButton.dataset.installed = 'true';
                    progressContainer.style.display = 'none';
                } catch (error) {
                    console.error('下载失败:', error);
                    window.downloadStates[tool.id].error = true;
                    downloadButton.textContent = '下载失败';
                    const errorMsg = error.message.includes('INVALID_FORMAT') ? 
                        '文件格式错误，请联系工具作者' : 
                        '下载失败，请检查网络后重试';
                    
                    progressStatus.textContent = errorMsg;
                    
                    setTimeout(() => {
                        downloadButton.textContent = '重试';
                        downloadButton.disabled = false;
                        progressStatus.textContent = '';
                    }, 3000);
                }
            });

            // 更新标题
            document.querySelector('.selected-tool-name').textContent = tool.name;
        }

        // 添加下载进度监听器
        ipcRenderer.on('download-progress', (event, { toolId, progress, current, total }) => {
            if (!window.downloadStates) window.downloadStates = {};
            
            // 如果是100%，表示下载完成
            if (progress === 100) {
                window.downloadStates[toolId] = { 
                    progress, 
                    current, 
                    total,
                    completed: true 
                };
                
                // 查找并更新当前工具的下载按钮状态
                const downloadButton = document.querySelector(`.download-button[data-tool-id="${toolId}"]`);
                if (downloadButton) {
                    downloadButton.textContent = '打开';
                    downloadButton.dataset.installed = 'true';
                    downloadButton.disabled = false;
                    
                    // 延迟一段时间后隐藏进度条
                    setTimeout(() => {
                        const progressContainer = downloadButton.parentElement.querySelector('.download-progress');
                        if (progressContainer) {
                            progressContainer.style.display = 'none';
                        }
                    }, 1000);
                }
            } else {
                window.downloadStates[toolId] = { progress, current, total };
            }
            
            // 更新进度条
            const toolInfo = document.querySelector('.tool-info');
            const progressBar = toolInfo.querySelector('.download-progress-bar');
            const progressStatus = toolInfo.querySelector('.download-status');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressStatus.textContent = `${(current / 1024 / 1024).toFixed(2)}MB / ${(total / 1024 / 1024).toFixed(2)}MB`;
            }
        });

        async function loadCharts() {
            try {
                console.log('开始加载谱面列表');
                const downloads = await ipcRenderer.invoke('get-down-json');
                console.log('获取到谱面列表:', downloads);
                
                if (!downloads) {
                    throw new Error('无法获取谱面列表数据');
                }

                const chartsList = document.getElementById('charts-list');
                chartsList.innerHTML = '';
                if (downloads.length === 0) {
                    chartsList.innerHTML = '<div class="error-message">暂无可用谱面资源</div>';
                    return;
                }

                downloads.forEach(chart => {
                    if (!chart || !chart.name) return;

                    const chartItem = document.createElement('div');
                    chartItem.className = 'tool-item';
                    chartItem.setAttribute('data-tooltip', chart.name);
                    
                    const iconContainer = document.createElement('div');
                    iconContainer.className = 'tool-icon';

                    const icon = document.createElement('img');
                    icon.src = chart.icon || 'assets/img/default-tool-icon.png';
                    icon.alt = chart.name;
                    icon.onerror = () => {
                        icon.src = 'assets/img/default-tool-icon.png';
                    };

                    const name = document.createElement('div');
                    name.className = 'tool-name';
                    name.textContent = chart.name;

                    iconContainer.appendChild(icon);
                    chartItem.appendChild(iconContainer);
                    chartItem.appendChild(name);

                    // 添加点击事件
                    chartItem.addEventListener('click', () => {
                        // 移除其他项的选中状态
                        document.querySelectorAll('#charts-list .tool-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // 添加当前项的选中状态
                        chartItem.classList.add('active');
                        
                        // 更新标题
                        document.querySelector('#charts .selected-tool-name').textContent = chart.name;
                        
                        // 加载网页
                        const webview = document.querySelector('#charts .docs-webview');
                        webview.src = chart.url;
                    });

                    chartsList.appendChild(chartItem);
                });

                // 默认选中第一个
                if (downloads.length > 0) {
                    const firstItem = chartsList.querySelector('.tool-item');
                    firstItem.click();
                }
            } catch (error) {
                console.error('加载谱面列表失败:', error);
                const chartsList = document.getElementById('charts-list');
                chartsList.innerHTML = '<div class="error-message">加载谱面列表失败，请稍后重试</div>';
            }
        }

        // 页面加载完成后加载谱面列表
        document.addEventListener('DOMContentLoaded', loadCharts);

        // 添加窗口控制按钮事件
        document.getElementById('minimize-button').addEventListener('click', () => {
            ipcRenderer.send('window-controls', 'minimize');
        });

        document.getElementById('maximize-button').addEventListener('click', () => {
            ipcRenderer.send('window-controls', 'maximize');
        });

        document.getElementById('close-button').addEventListener('click', () => {
            ipcRenderer.send('window-controls', 'close');
        });

        // 监听窗口最大化状态变化
        window.addEventListener('resize', () => {
            const maximizeButton = document.getElementById('maximize-button');
            if (window.outerWidth === screen.availWidth && window.outerHeight === screen.availHeight) {
                maximizeButton.innerHTML = `
                    <svg width="12" height="12" viewBox="0 0 12 12">
                        <path fill="currentColor" d="M3 3v6h6V3H3zm5 5H4V4h4v4z"/>
                    </svg>
                `;
            } else {
                maximizeButton.innerHTML = `
                    <svg width="12" height="12" viewBox="0 0 12 12">
                        <path fill="currentColor" d="M2 2v8h8V2H2zm7 7H3V3h6v6z"/>
                    </svg>
                `;
            }
        });

        // 添加开发者控制台按钮点击事件
        document.getElementById('admin-console').addEventListener('click', () => {
            ipcRenderer.send('open-admin-console');
        });
    </script>
</body>
</html>